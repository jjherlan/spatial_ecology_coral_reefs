---
title: "Appendix II"
author: "jjh"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y %H:%M')`"
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(betareg)
library(plyr)
library(lmtest)
library(glmmTMB)
library(boot)
library(emmeans)
library(brms)
library(mvtnorm)
library(nlme)
library(rstan)
library(lmtest)
library(boot)
library(car)
library(xtable)
library(tidyr)
library(ordinal)
library(VGAM)
#ibrary(rjags) ; load.module('glm') ; load.module('dic')    # need a separate working JAGS installation. 
#The rjags package is just an interface to the JAGS library
#Make sure you have installed JAGS-4.x.y.exe (for any x >=0, y>=0) from
#http://www.sourceforge.net/projects/mcmc-jags/files
library(mosaic)  
library(arm)
library(cowplot)
library(qqtest)  #for uncertainty intervals in qqplot
library(modelsummary)
library(kableExtra)
library(gt)
require(MASS)
require(tinytex)
```

*From* **Damgaard & Irvine (2019)** Using the beta distribution to analyse plant cover data *Journal of Ecology. 107:2747-2759*

Wrote a function to create a table from `betreg` object that can be used in `xtable()`

```{r, include = TRUE}
p_cover = read_csv('rpn_percent_cover.csv') %>% 
  group_by(Site) %>%
  mutate(
    pland_decimal = pland*0.01
  ) %>%
  mutate_at(vars(Site, cover, plot_id), factor)
```

```{r}
p_cover
```

```{r}
head(p_cover)
```

```{r}
ggplot(p_cover, aes(x = pland_decimal)) +
  geom_histogram(fill = "#333399") + 
  #below here is ylabel, xlabel, and main title
  ylab("Frequency") +
  xlab(NULL) +
  ggtitle(expression("Coral Cover (%)")) +
  theme_bw() +
  facet_wrap(~ Site, ncol = 1) +
  #theme sets sizes, text, etc
  theme(axis.title.x = element_text(size = 14), 
        axis.title.y = element_text(size = 14), 
        axis.text.y  = element_text(size= 10),
        axis.text.x  = element_text(size = 12), 
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 14),
        # change plot background, grid lines, etc (just examples so you can see)
        panel.background = element_rect(fill = "white"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "white"),
        legend.background = element_rect(fill = "white"),
        strip.text.x = element_text(size = 12, colour = "#FFFFFF"),
        strip.background = element_rect(fill = '#000066')
  )
```

```{r}
plot(pland_decimal ~ Site, data = p_cover)
```

```{r}
p_cover.mean <-
  p_cover %>%
  group_by(Site) %>%
  dplyr::summarise(mean = mean(pland_decimal))
```

```{r}
p_cover.mean
```

## Methods for analyzing percent cover of pocilloporid coral

One option for dealing with the 0 and 1 values is to transform them to be slightly less than one or more than zero. This approach assumes that the data are consistent with a common beta distribution. We fit five models to the data: three variations on the beta model and two linear model approaches.

A beta regression assuming a common spatial aggregation $\delta$ or precision parameter ($\phi$) (object named: mod.beta1). Notice that $\delta= \frac{1}{1+\phi}$ and $\phi=\frac{(1-\delta)}{\delta}$. A beta regression assuming each year had a different $\phi$ parameter (object named: mod.beta2).

Another option for modeling the data is to use a zero-one augmented beta model. Currently, the betareg package does not implement this model directly. Therefore, we follow the theoretical results shown in Ospina and Ferrari (2010) that suggest a three-part model can be fit to the data. Basically, we use logistic regression with response an indicator variable for whether or not the plot had zero recorded cover, another logistic regression with response an indicator for whether or not the plot had 100$\%$ recorded percent cover, and then the beta regression is used to model the continuous percent cover observations ranging from greater than 0 and less than 1.

Other options based on assuming that the residuals are normally distributed is to use a linear model with a logit-transformed response (object named: mod.lmlogit) or a linear model with response untransformed proportions (object named: mod.lmraw).

For comparison this applies a logit-transformation to the empirical proportions and then uses a standard linear regression model.

**Raw data - no transformation**

```{r}
p_cover_mod.aov1 <- aov(pland_decimal ~ Site, data = p_cover)
summary(p_cover_mod.aov1)
```

```{r}
p_cover_mod.lm1 <- lm(pland_decimal ~ Site, data = p_cover)
summary(p_cover_mod.lm1)
```

```{r}
par(mfrow = c(2, 2))
plot(p_cover_mod.lm1)
```

```{r}
Anova(p_cover_mod.lm1, type = "III")
```

One option to deal with 0 and 100 percent cover is to add and subtract a small amount to those values

```{r}
transform01 <- function(x) {
  (x * (length(x) - 1) + 0.5) / (length(x))
}
```

```{r}
p_cover$pland_decimal_scaled <- transform01(p_cover$pland_decimal)
```

**Logit-transformation**

```{r}
p_cover_mod.lm2 <- lm(logit(pland_decimal_scaled) ~ Site, data = p_cover) 
```

```{r}
summary(p_cover_mod.lm2)
```

```{r}
par(mfrow = c(2, 2))
plot(p_cover_mod.lm2)
```

```{r}
Anova(p_cover_mod.lm2, type = "III")
```

**Generalized-linear model**

```{r}
p_cover_mod.glm1 <- glm(pland_decimal ~ Site, family = binomial, data = p_cover)
summary(p_cover_mod.glm1)
```

```{r}
par(mfrow = c(2, 2))
plot(p_cover_mod.glm1)
```

```{r}
Anova(p_cover_mod.glm1, type = "III")
```

**Beta Regression I:** $\phi$ does not vary

```{r}
p_cover_mod.beta1 <- betareg(pland_decimal_scaled ~ Site, data = p_cover, link = c("logit"), link.phi = NULL, type = c("ML"))
```

```{r}
summary(p_cover_mod.beta1)
```

**Beta Regression II:** $\phi$ does vary (by **Site**)

```{r}
p_cover_mod.beta2 <- betareg(pland_decimal_scaled ~ Site | Site, data = p_cover, link = c("logit"), link.phi = NULL, type = c("ML"))
```

**Extract AIC from beta regression models**

```{r}
p_cover_mod.beta1_aic <- AIC(p_cover_mod.beta1)
p_cover_mod.beta2_aic <- AIC(p_cover_mod.beta2)
```

```{r}
p_cover_mod.beta1_aic
p_cover_mod.beta2_aic
```

## Interpreting results for pocilloporid corals

In order to choose between the beta regression model with a common $\phi$ versus different $\phi$, I used **AIC** but a *likelihood ratio* or *wald test* could be used. Using **AIC**, the model with varying $\phi$ values had a lower AIC (-1518.568 compared to -1494.524) and therefore more support. We interpret the output from beta regression with the following:

The model we fit assumes $$logit(\mu_j)=\beta_0+\beta_1 Ind_{grp2},$$ where $Ind_{grp2}$ is an indicator for group 2 and $j$ denotes the group membership so $j=1$ or $j=2$. We have $logit(\mu_2)-logit(\mu_1)=\beta_1$, which is equivalent to $$log(\frac{\mu_2}{1-\mu_2})-log(\frac{\mu_1}{1-\mu_1})= \beta_1.$$

The $\frac{\mu_j}{1-\mu_j}$ is interpreted as the odds of proportion cover in group $j$. Therefore,

$$log(\frac{\mu_2}{1-\mu_2}/\frac{\mu_1}{1-\mu_1})=\beta_1$$ is the log- odds ratio of cover in group 2 compared to group 1, $$(\frac{\mu_2}{1-\mu_2}/\frac{\mu_1}{1-\mu_1})=exp(\beta_1).$$

Then $exp(\beta_1)$ is the factor increase/decrease in odds of proportion cover for group 2 compared to group 1, where $exp(\beta_1)>1$ is an increase and $exp(\beta_1)<1$ is a decrease, and $exp(\beta_1) \approx 1$ means essentially no change.
